<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronCalc Plugin - Basic Usage Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
        }
        
        .formula-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }
        
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .example-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
        }
        
        .example-card h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .example-formula {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
        }
        
        .metrics {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .metrics h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #bbdefb;
        }
        
        .metric-item:last-child {
            border-bottom: none;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status.ready {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ IronCalc Formula Engine Plugin Demo</h1>
        
        <div id="status" class="status loading">
            üîÑ Loading IronCalc plugin...
        </div>
        
        <div id="main-content" style="display: none;">
            <h2>Interactive Formula Evaluator</h2>
            
            <div class="formula-section">
                <div class="input-group">
                    <label for="formula">Formula (start with =):</label>
                    <input type="text" id="formula" value="=SUM(1,2,3,4,5)" placeholder="=SUM(1,2,3,4,5)">
                </div>
                
                <div class="input-group">
                    <label for="sheet">Sheet Name:</label>
                    <input type="text" id="sheet" value="Sheet1">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label for="row">Row:</label>
                        <input type="text" id="row" value="1">
                    </div>
                    <div class="input-group">
                        <label for="col">Column:</label>
                        <input type="text" id="col" value="1">
                    </div>
                </div>
                
                <button id="evaluate-btn" onclick="evaluateFormula()">
                    üìä Evaluate Formula
                </button>
                
                <button onclick="clearResult()">
                    üóëÔ∏è Clear Result
                </button>
                
                <div id="result"></div>
            </div>
            
            <h2>Example Formulas</h2>
            <div class="examples">
                <div class="example-card">
                    <h3>Mathematical Functions</h3>
                    <div class="example-formula" onclick="setFormula('=SUM(10,20,30,40,50)')">
                        =SUM(10,20,30,40,50)
                    </div>
                    <div class="example-formula" onclick="setFormula('=AVERAGE(15,25,35)')">
                        =AVERAGE(15,25,35)
                    </div>
                    <div class="example-formula" onclick="setFormula('=MAX(5,15,8,23,12)')">
                        =MAX(5,15,8,23,12)
                    </div>
                </div>
                
                <div class="example-card">
                    <h3>Arithmetic Operations</h3>
                    <div class="example-formula" onclick="setFormula('=100+200*0.1')">
                        =100+200*0.1
                    </div>
                    <div class="example-formula" onclick="setFormula('=(50+25)*2')">
                        =(50+25)*2
                    </div>
                    <div class="example-formula" onclick="setFormula('=1000/8')">
                        =1000/8
                    </div>
                </div>
                
                <div class="example-card">
                    <h3>Logical Functions</h3>
                    <div class="example-formula" onclick="setFormula('=IF(10>5,\"Greater\",\"Less\")')">
                        =IF(10>5,"Greater","Less")
                    </div>
                    <div class="example-formula" onclick="setFormula('=IF(COUNT(1,2,3)>2,\"Many\",\"Few\")')">
                        =IF(COUNT(1,2,3)>2,"Many","Few")
                    </div>
                </div>
                
                <div class="example-card">
                    <h3>Error Examples</h3>
                    <div class="example-formula" onclick="setFormula('=1/0')">
                        =1/0 (Division by zero)
                    </div>
                    <div class="example-formula" onclick="setFormula('=UNKNOWN_FUNC(1,2,3)')">
                        =UNKNOWN_FUNC(1,2,3)
                    </div>
                </div>
            </div>
            
            <h2>Bulk Evaluation Demo</h2>
            <button onclick="runBulkEvaluation()">
                üìä Run Bulk Formula Evaluation (10 formulas)
            </button>
            <div id="bulk-result"></div>
            
            <h2>Performance Metrics</h2>
            <button onclick="updateMetrics()">üîÑ Refresh Metrics</button>
            <div id="metrics" class="metrics">
                <h3>Plugin Performance</h3>
                <div id="metrics-content">
                    Click "Refresh Metrics" to see performance data
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let ironCalcPlugin = null;
        let isLoading = false;

        // Mock plugin for demo purposes
        class MockIronCalcPlugin {
            constructor() {
                this.metrics = {
                    totalEvaluations: 0,
                    averageTime: 0,
                    memoryUsage: 0,
                    successRate: 100
                };
            }

            async execute(operation, params) {
                this.metrics.totalEvaluations++;
                const startTime = performance.now();
                
                if (operation === 'evaluateFormula') {
                    const result = this.mockEvaluateFormula(params.formula);
                    const endTime = performance.now();
                    const executionTime = endTime - startTime;
                    
                    // Update metrics
                    this.metrics.averageTime = (this.metrics.averageTime + executionTime) / 2;
                    this.metrics.memoryUsage = Math.random() * 50 + 10; // Mock memory usage
                    
                    return {
                        ...result,
                        execution_time_ms: Math.round(executionTime),
                        cell_address: this.getCellAddress(params.col, params.row)
                    };
                } else if (operation === 'bulkEvaluate') {
                    return params.formulas.map(f => this.mockEvaluateFormula(f.formula));
                }
                
                throw new Error(`Unknown operation: ${operation}`);
            }

            mockEvaluateFormula(formula) {
                // Remove leading =
                const expr = formula.startsWith('=') ? formula.substring(1) : formula;
                
                try {
                    // Handle Excel functions
                    if (expr.startsWith('SUM(')) {
                        const args = this.extractArgs(expr, 'SUM');
                        const sum = args.reduce((a, b) => a + b, 0);
                        return { value: sum.toString(), error: null };
                    } else if (expr.startsWith('AVERAGE(')) {
                        const args = this.extractArgs(expr, 'AVERAGE');
                        const avg = args.reduce((a, b) => a + b, 0) / args.length;
                        return { value: avg.toString(), error: null };
                    } else if (expr.startsWith('MAX(')) {
                        const args = this.extractArgs(expr, 'MAX');
                        const max = Math.max(...args);
                        return { value: max.toString(), error: null };
                    } else if (expr.startsWith('MIN(')) {
                        const args = this.extractArgs(expr, 'MIN');
                        const min = Math.min(...args);
                        return { value: min.toString(), error: null };
                    } else if (expr.startsWith('COUNT(')) {
                        const args = this.extractArgs(expr, 'COUNT');
                        return { value: args.length.toString(), error: null };
                    } else if (expr.startsWith('IF(')) {
                        return this.handleIfFunction(expr);
                    } else if (expr.includes('/0')) {
                        return { value: '', error: '#DIV/0!' };
                    } else if (expr.includes('UNKNOWN_FUNC')) {
                        return { value: '', error: '#NAME?' };
                    } else {
                        // Try to evaluate as simple arithmetic
                        const result = this.evaluateArithmetic(expr);
                        return { value: result.toString(), error: null };
                    }
                } catch (error) {
                    return { value: '', error: '#VALUE!' };
                }
            }

            extractArgs(expr, funcName) {
                const start = funcName.length + 1;
                const end = expr.length - 1;
                const argsStr = expr.substring(start, end);
                return argsStr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            }

            handleIfFunction(expr) {
                // Simple IF implementation
                const args = expr.substring(3, expr.length - 1).split(',');
                if (args.length >= 2) {
                    const condition = args[0].trim();
                    const trueValue = args[1].trim().replace(/"/g, '');
                    const falseValue = args.length > 2 ? args[2].trim().replace(/"/g, '') : 'FALSE';
                    
                    // Simple condition evaluation
                    if (condition.includes('>')) {
                        const parts = condition.split('>');
                        const left = parseFloat(parts[0].trim());
                        const right = parseFloat(parts[1].trim());
                        return { value: left > right ? trueValue : falseValue, error: null };
                    }
                }
                return { value: 'FALSE', error: null };
            }

            evaluateArithmetic(expr) {
                // Very simple arithmetic evaluation
                try {
                    // Replace common patterns
                    const cleanExpr = expr.replace(/\s/g, '');
                    
                    // Handle parentheses first
                    if (cleanExpr.includes('(') && cleanExpr.includes(')')) {
                        const parenRegex = /\(([^()]+)\)/;
                        const match = cleanExpr.match(parenRegex);
                        if (match) {
                            const innerResult = this.evaluateArithmetic(match[1]);
                            const newExpr = cleanExpr.replace(match[0], innerResult);
                            return this.evaluateArithmetic(newExpr);
                        }
                    }
                    
                    // Handle multiplication and division first
                    if (cleanExpr.includes('*') || cleanExpr.includes('/')) {
                        const parts = cleanExpr.split(/([*/])/);
                        let result = parseFloat(parts[0]);
                        for (let i = 1; i < parts.length; i += 2) {
                            const operator = parts[i];
                            const operand = parseFloat(parts[i + 1]);
                            if (operator === '*') {
                                result *= operand;
                            } else if (operator === '/') {
                                if (operand === 0) throw new Error('Division by zero');
                                result /= operand;
                            }
                        }
                        return result;
                    }
                    
                    // Handle addition and subtraction
                    if (cleanExpr.includes('+') || cleanExpr.includes('-')) {
                        const parts = cleanExpr.split(/([+-])/);
                        let result = parseFloat(parts[0]);
                        for (let i = 1; i < parts.length; i += 2) {
                            const operator = parts[i];
                            const operand = parseFloat(parts[i + 1]);
                            if (operator === '+') {
                                result += operand;
                            } else if (operator === '-') {
                                result -= operand;
                            }
                        }
                        return result;
                    }
                    
                    // Single number
                    return parseFloat(cleanExpr);
                } catch (error) {
                    throw error;
                }
            }

            getCellAddress(col, row) {
                return String.fromCharCode(64 + col) + row;
            }

            getPerformanceMetrics() {
                return {
                    averageProcessingTime: this.metrics.averageTime,
                    throughput: this.metrics.totalEvaluations,
                    memoryUsage: this.metrics.memoryUsage * 1024 * 1024,
                    successRate: this.metrics.successRate / 100
                };
            }
        }

        // Initialize the plugin
        async function initPlugin() {
            try {
                updateStatus('loading', 'üîÑ Initializing IronCalc plugin...');
                
                // Simulate loading time
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                ironCalcPlugin = new MockIronCalcPlugin();
                
                updateStatus('ready', '‚úÖ IronCalc plugin ready!');
                document.getElementById('main-content').style.display = 'block';
                
            } catch (error) {
                console.error('Failed to initialize plugin:', error);
                updateStatus('error', `‚ùå Failed to load plugin: ${error.message}`);
            }
        }

        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        // Global functions for HTML onclick handlers
        window.evaluateFormula = async function() {
            if (!ironCalcPlugin || isLoading) return;
            
            const formula = document.getElementById('formula').value.trim();
            const sheet = document.getElementById('sheet').value.trim() || 'Sheet1';
            const row = parseInt(document.getElementById('row').value) || 1;
            const col = parseInt(document.getElementById('col').value) || 1;
            
            if (!formula) {
                showResult('Please enter a formula', 'error');
                return;
            }
            
            const btn = document.getElementById('evaluate-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Evaluating...';
            isLoading = true;
            
            try {
                const result = await ironCalcPlugin.execute('evaluateFormula', {
                    formula,
                    sheet,
                    row,
                    col
                });
                
                if (result.error) {
                    showResult(`Error: ${result.error}`, 'error');
                } else {
                    showResult(
                        `Result: ${result.value}\n` +
                        `Cell: ${result.cell_address}\n` +
                        `Execution time: ${result.execution_time_ms}ms`,
                        'success'
                    );
                }
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìä Evaluate Formula';
                isLoading = false;
            }
        };

        window.setFormula = function(formula) {
            document.getElementById('formula').value = formula;
        };

        window.clearResult = function() {
            document.getElementById('result').innerHTML = '';
        };

        window.runBulkEvaluation = async function() {
            if (!ironCalcPlugin || isLoading) return;
            
            isLoading = true;
            const bulkResultEl = document.getElementById('bulk-result');
            bulkResultEl.innerHTML = '<div class="loading">‚è≥ Running bulk evaluation...</div>';
            
            const formulas = [
                { formula: '=SUM(1,2,3,4,5)', sheet: 'Sheet1', row: 1, col: 1 },
                { formula: '=AVERAGE(10,20,30)', sheet: 'Sheet1', row: 2, col: 1 },
                { formula: '=MAX(5,15,25)', sheet: 'Sheet1', row: 3, col: 1 },
                { formula: '=MIN(5,15,25)', sheet: 'Sheet1', row: 4, col: 1 },
                { formula: '=COUNT(1,2,3,4,5)', sheet: 'Sheet1', row: 5, col: 1 },
                { formula: '=IF(10>5,"True","False")', sheet: 'Sheet1', row: 6, col: 1 },
                { formula: '=100+200', sheet: 'Sheet1', row: 7, col: 1 },
                { formula: '=50*2', sheet: 'Sheet1', row: 8, col: 1 },
                { formula: '=1000/10', sheet: 'Sheet1', row: 9, col: 1 },
                { formula: '=(25+75)*2', sheet: 'Sheet1', row: 10, col: 1 }
            ];
            
            try {
                const startTime = performance.now();
                const results = await ironCalcPlugin.execute('bulkEvaluate', { formulas });
                const endTime = performance.now();
                
                let html = `<div class="result success">`;
                html += `<h4>Bulk Evaluation Results (${Math.round(endTime - startTime)}ms)</h4>`;
                
                results.forEach((result, index) => {
                    const formula = formulas[index].formula;
                    if (result.error) {
                        html += `<div>‚ùå ${formula} ‚Üí Error: ${result.error}</div>`;
                    } else {
                        html += `<div>‚úÖ ${formula} ‚Üí ${result.value}</div>`;
                    }
                });
                
                html += '</div>';
                bulkResultEl.innerHTML = html;
                
            } catch (error) {
                bulkResultEl.innerHTML = `<div class="result error">Bulk evaluation failed: ${error.message}</div>`;
            } finally {
                isLoading = false;
            }
        };

        window.updateMetrics = function() {
            if (!ironCalcPlugin) return;
            
            const metrics = ironCalcPlugin.getPerformanceMetrics();
            const metricsContent = document.getElementById('metrics-content');
            
            metricsContent.innerHTML = `
                <div class="metric-item">
                    <span>Total Evaluations:</span>
                    <span>${metrics.throughput}</span>
                </div>
                <div class="metric-item">
                    <span>Average Processing Time:</span>
                    <span>${metrics.averageProcessingTime.toFixed(2)}ms</span>
                </div>
                <div class="metric-item">
                    <span>Memory Usage:</span>
                    <span>${Math.round(metrics.memoryUsage / 1024 / 1024)}MB</span>
                </div>
                <div class="metric-item">
                    <span>Success Rate:</span>
                    <span>${Math.round(metrics.successRate * 100)}%</span>
                </div>
            `;
        };

        function showResult(message, type) {
            const resultEl = document.getElementById('result');
            resultEl.className = `result ${type}`;
            resultEl.innerHTML = message.replace(/\n/g, '<br>');
        }

        // Initialize when the page loads
        initPlugin();
    </script>
</body>
</html>